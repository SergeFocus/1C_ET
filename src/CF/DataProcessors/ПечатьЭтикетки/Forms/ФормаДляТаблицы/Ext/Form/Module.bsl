// sza151020-1552 
// sza150512-1709 фикс
// sza150418-2215 
// sza150407-0016 ППФ
// sza141124-2315 ФорматЭтикетки
// sza141119-0314 доп
// sza140903-1140 
// sza140506-0926  
// sza130913-1205 : 
&НаКлиенте
Процедура ВидЦенПриИзменении(Элемент)
	
	сменитьценутаблицы();
	ОбновитьПримеры();
	
КонецПроцедуры

&НаКлиенте
Процедура НапечататьЭтикеткиДляВсехСтрокТаблицы(Команда)
	
	Если ОбщееКоличество() <= 30 Тогда
		НапечататьЭтикеткиФрагмент();
	Иначе
		ПоказатьВопрос(Новый ОписаниеОповещения("НапечататьЭтикеткиДляВсехСтрокТаблицыЗавершение", ЭтаФорма), ОбщийМодульПовтор.ПолучитьТекстНаЯзыке("Вы уверены, что хотите распечатать такое число") + " (" + Объект.Количество + ")?", режимдиалогавопрос.ДаНет);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура НапечататьЭтикеткиДляВсехСтрокТаблицыЗавершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	Если РезультатВопроса = КодВозвратаДиалога.Да Тогда		
		НапечататьЭтикеткиФрагмент();			
	КонецЕсли;
		
КонецПроцедуры

&НаКлиенте
Процедура НапечататьЭтикеткиФрагмент()
	
		ПараметрыФормыПечати = Новый Структура;
		ПараметрыФормыПечати.Вставить("НаименованиеДокумента", ОбщийМодульПовтор.ПолучитьТекстНаЯзыке("Этикетки"));
		ПараметрыФормыПечати.Вставить("НеПечататьНичегоДополнительно", ИСТИНА);
		ФормаПечати = получитьформу("ОбщаяФорма.ФормаПечати", ПараметрыФормыПечати);
		
		// тут
		ЕстьЧтоПечататьВФорме = НапечататьЭтикеткиДляВсехСтрокТаблицыНаСервере(ФормаПечати.Результат);
		
		Если ЕстьЧтоПечататьВФорме Тогда
			ФормаПечати.Заголовок = ПараметрыФормыПечати.НаименованиеДокумента;
			ФормаПечати.Открыть();
		Иначе
			ФормаПечати.Результат.Напечатать();// не принтер
			ФормаПечати = Неопределено;
		КонецЕсли;	

КонецПроцедуры

&НаСервере
Функция   НапечататьЭтикеткиДляВсехСтрокТаблицыНаСервере(ТабДокОбщийРезультат)
	
	ЕстьЧтоПечататьВФорме = ЛОЖЬ;
	
	ЧислоЭтикетокНаЛистеПоГоризонтали = 0;
	Если ЗначениеЗаполнено(Объект.ПроизвольнаяПечатнаяФорма)
		И Объект.ПроизвольнаяПечатнаяФорма.ИспользоватьОтступыМасштабИПринтер
		И НЕ Объект.ПроизвольнаяПечатнаяФорма.ЧислоЭтикетокНаЛистеПоГоризонтали = 0 Тогда
		
		ЧислоЭтикетокНаЛистеПоГоризонтали = Объект.ПроизвольнаяПечатнаяФорма.ЧислоЭтикетокНаЛистеПоГоризонтали;
	КонецЕсли;
	
	Если ЧислоЭтикетокНаЛистеПоГоризонтали = 0 Тогда
		ЧислоЭтикетокНаЛистеПоГоризонтали = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ЧислоЭтикетокНаЛистеПоГоризонтали");
		Если ЧислоЭтикетокНаЛистеПоГоризонтали = 0 Тогда
			ЧислоЭтикетокНаЛистеПоГоризонтали = 1;
		КонецЕсли;	
	КонецЕсли;
	
	ЧислоЭтикетокНаЛистеПоВертикали = 0;
	Если ЗначениеЗаполнено(Объект.ПроизвольнаяПечатнаяФорма)
		И Объект.ПроизвольнаяПечатнаяФорма.ИспользоватьОтступыМасштабИПринтер
		И НЕ Объект.ПроизвольнаяПечатнаяФорма.ЧислоЭтикетокНаЛистеПоВертикали = 0 Тогда
		
		ЧислоЭтикетокНаЛистеПоВертикали = Объект.ПроизвольнаяПечатнаяФорма.ЧислоЭтикетокНаЛистеПоВертикали;
		
	КонецЕсли;
	
	Если ЧислоЭтикетокНаЛистеПоВертикали = 0 Тогда
		ЧислоЭтикетокНаЛистеПоВертикали = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ЧислоЭтикетокНаЛистеПоВертикали");
		Если ЧислоЭтикетокНаЛистеПоВертикали = 0 Тогда
			ЧислоЭтикетокНаЛистеПоВертикали = 1;
		КонецЕсли;	
	КонецЕсли;
	
	ТекущияПозицияПоГоризонтали = 1;
	ТекущияПозицияПоВертикали 	= 1;
	ЧислоЭтикетокНаСтранице = ЧислоЭтикетокНаЛистеПоВертикали * ЧислоЭтикетокНаЛистеПоГоризонтали;
	
	Если ЗначениеЗаполнено(Объект.ПроизвольнаяПечатнаяФорма)
		И Объект.ПроизвольнаяПечатнаяФорма.ИспользоватьОтступыМасштабИПринтер Тогда
		
		НеВыводитьРазделитель = Объект.ПроизвольнаяПечатнаяФорма.НеВыводитьРазделитель;
	Иначе
		НеВыводитьРазделитель = ЧислоЭтикетокНаСтранице = 1;	
	КонецЕсли;

	СтрокаПечати = Новый ТабличныйДокумент;
	СтрокаПечати.ИмяПараметровПечати  = "СТРОКАЭТИКЕТКИ";
	СтрокаПечати.КлючПараметровПечати = СтрокаПечати.ИмяПараметровПечати;
	КолонокВСтрокеПечати = 0;
	СтрокаНапечать = ЛОЖЬ;
	
	Для Каждого СтрокаТовара ИЗ Объект.Товары цикл
		
		Если ЗначениеЗаполнено(СтрокаТовара.Номенклатура) Тогда
			ШтрихКод = ПолучитьШтрихКодТовара(СтрокаТовара.Номенклатура, СтрокаТовара.цена, СтрокаТовара.СерияНоменклатуры, СтрокаТовара.ЕдиницаИзмерения);
			Если НЕ ЗначениеЗаполнено(ОбъектТипШтрихКода) Тогда
				Объект.ТипШтрихКода = МенеджерОборудованияВызовСервера.ОпределитьТипШтрихкода(ШтрихКод);
			Иначе
				Объект.ТипШтрихКода = ОбъектТипШтрихКода;
			КонецЕсли;			
			ТекстСШтрихКодом        = ПолучитьТекстСШтрихКодомТовара(СтрокаТовара.Номенклатура, СтрокаТовара.цена, ШтрихКод, СтрокаТовара.СерияНоменклатуры, СтрокаТовара.ЕдиницаИзмерения);
			Объект.ТекстЗаголовка   = ПолучитьТекстЗаголовка(СтрокаТовара.Номенклатура, СтрокаТовара.цена, ШтрихКод, СтрокаТовара.СерияНоменклатуры);
			Объект.ДополнительнаяСтрокаЭтикетки = ПолучитьДополнительнуюСтрокуЭтикетки(СтрокаТовара.Номенклатура, СтрокаТовара.цена, ШтрихКод, СтрокаТовара.СерияНоменклатуры);
			
			Объект.Номенклатура = СтрокаТовара.Номенклатура;
			Объект.НоменклатурнаяГруппа = Объект.Номенклатура.НоменклатурнаяГруппа;
			ОпределитьПроизвольнуюПечатнуюФорму(ИСТИНА);		
			
			Если ЗначениеЗаполнено( Объект.ПроизвольнаяПечатнаяФорма) Тогда
				Если  Объект.ПроизвольнаяПечатнаяФорма.ШиринаКолонокЗаданаМакетом 
					И СтрокаНапечать Тогда //  следует насильно произвести новую строку
					
					ТекущияПозицияПоГоризонтали = 1;
					ТекущияПозицияПоВертикали = ТекущияПозицияПоВертикали + 1;
					ТабДокОбщийРезультат.Вывести(СтрокаПечати);
					СтрокаНапечать = ЛОЖЬ;
					
					СтрокаПечати = Новый ТабличныйДокумент;
					СтрокаПечати.ИмяПараметровПечати  = "СТРОКАЭТИКЕТКИ";
					СтрокаПечати.КлючПараметровПечати = СтрокаПечати.ИмяПараметровПечати;
					КолонокВСтрокеПечати = 0;
				КонецЕсли;
			КонецЕсли;
			
			// !!сюда!
			Табдок = ОбщийМодульСерверНапечататьЭтикетку(ШтрихКод, ТекстСШтрихКодом, , , КолонокВСтрокеПечати);
			
			Если НЕ Табдок = Неопределено Тогда			
				
				СчетчикЭтикеток = 1;
			
				Пока СчетчикЭтикеток <= СтрокаТовара.Количество Цикл
					Если НЕ ЕстьЧтоПечататьВФорме
						И ПустаяСтрока(ИмяПринтера) Тогда
						
						ЕстьЧтоПечататьВФорме = ИСТИНА;	
					КонецЕсли;
					
					СтрокаНапечать = ИСТИНА;
					СтрокаПечати.Присоединить(Табдок, 0);	
					КолонокВСтрокеПечати = КолонокВСтрокеПечати + 1;
					
					ТекущияПозицияПоГоризонтали = ТекущияПозицияПоГоризонтали + 1;
					Если ТекущияПозицияПоГоризонтали > ЧислоЭтикетокНаЛистеПоГоризонтали Тогда
						ТекущияПозицияПоГоризонтали = 1;
						ТекущияПозицияПоВертикали = ТекущияПозицияПоВертикали + 1;
						ТабДокОбщийРезультат.Вывести(СтрокаПечати);
						СтрокаНапечать = ЛОЖЬ;
						
						СтрокаПечати = Новый ТабличныйДокумент;
						СтрокаПечати.ИмяПараметровПечати  = "СТРОКАЭТИКЕТКИ";
						СтрокаПечати.КлючПараметровПечати = СтрокаПечати.ИмяПараметровПечати;
						КолонокВСтрокеПечати = 0;
					КонецЕсли;
					
					Если НЕ НеВыводитьРазделитель
						И ТекущияПозицияПоВертикали > ЧислоЭтикетокНаЛистеПоВертикали Тогда
						
						ТекущияПозицияПоВертикали = 1;
						ТабДокОбщийРезультат.ВывестиГоризонтальныйРазделительСтраниц();
					КонецЕсли;	
					
					СчетчикЭтикеток = СчетчикЭтикеток + 1;
				КонецЦикла;
				
			КонецЕсли;	
		КонецЕсли;		
	КонецЦикла;
	
	Если СтрокаНапечать Тогда		
		ТабДокОбщийРезультат.Вывести(СтрокаПечати);						
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Объект.ПроизвольнаяПечатнаяФорма)
		И Объект.ПроизвольнаяПечатнаяФорма.ИспользоватьОтступыМасштабИПринтер Тогда
		
		ОбщийМодульТекстСервер.УстановитьПараметрыПечатиДляПроизвольнойПечатнойФормы(ТабДокОбщийРезультат, Объект.ПроизвольнаяПечатнаяФорма, ИмяПринтера);
		
	Иначе
		ТабДокОбщийРезультат.РазмерКолонтитулаСверху = 0;
		ТабДокОбщийРезультат.РазмерКолонтитулаСнизу  = 0;
		ТабДокОбщийРезультат.ПолеСверху 	= 0;
		ТабДокОбщийРезультат.ПолеСлева 		= 0;
		ТабДокОбщийРезультат.ПолеСнизу 		= 0;
		ТабДокОбщийРезультат.ПолеСправа 	= 0;
		ТабДокОбщийРезультат.АвтоМасштаб 	= ИСТИНА;				
		
		Если ЗначениеЗаполнено(ИмяПринтера) Тогда
			ТабДокОбщийРезультат.ИмяПринтера = ИмяПринтера;
		КонецЕсли;
	КонецЕсли;
	
	ОбщийМодульСервер.ДобавитьСобытиеЖурналаНаСервере(ОбщийМодульПовтор.ПолучитьТекстНаЯзыке("Напечатал этикетку для таблицы."), 2);
	
	Возврат ЕстьЧтоПечататьВФорме;
	
КонецФункции

&НаСервере
Процедура ОбновитьПримеры()
	
	ОбновитьТекстДополнительнойСтроки();
	
	Объект.ШтрихКод = "";
	ПримерШтрихКодаДляПервойСтрокиТаблицы = "";
	ПримерТекстаСШтрихКодом = "";
	
	Если Объект.Товары.Количество() > 0
		И ЗначениеЗаполнено(Объект.Товары[0].Номенклатура) Тогда		
		
		Если ЗначениеЗаполнено(Объект.ФормулаФормированияШтрихКода) Тогда
			Попытка 
				Объект.Номенклатура = Объект.Товары[0].Номенклатура;
				Объект.Цена = Объект.Товары[0].Цена;
				Если Объект.цена = 0 тогда
					Объект.Цена = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Объект.Номенклатура, Объект.ВидЦен, Объект.Дата, ИСТИНА, , , , , , , Объект.Товары[0].ЕдиницаИзмерения);
					Если Объект.цена = 0 тогда
						Объект.Цена = Объект.Товары[0].Цена;	
						Если Объект.цена = 0 тогда
							Объект.Цена = Объект.Номенклатура.Цена;	
						КонецЕсли;
					КонецЕсли;	
				КонецЕсли;
				
				ПримерШтрихКодаДляПервойСтрокиТаблицы = ОбщийМодульТоварСервер.УстановитьШтрихКодНоменклатурыПоФормуле(Объект.Товары[0].Номенклатура, Объект.ФормулаФормированияШтрихКода.Формула, Объект.ВидЦен, Объект.Дата, Объект.цена, Объект.Товары[0].СерияНоменклатуры);
				Объект.ШтрихКод = ПримерШтрихКодаДляПервойСтрокиТаблицы;
				
			Исключение				
				ТекстОписаниеОшибки = ОписаниеОшибки();
				Сообщение = Новый СообщениеПользователю;
				Сообщение.Текст = ОбщийМодульПовтор.ПолучитьТекстНаЯзыке("Произошла ошибка") + ": " + ТекстОписаниеОшибки;
				Сообщение.Поле 	= "ФормулаФормированияШтрихКода";
				Сообщение.УстановитьДанные(Объект);
				Сообщение.Сообщить();
				
			КонецПопытки;
		Иначе
			Объект.ШтрихКод = Объект.Товары[0].Номенклатура.ОсновнойШтрихКод;
			ПримерШтрихКодаДляПервойСтрокиТаблицы = Объект.ШтрихКод;
		КонецЕсли;		
		
	КонецЕсли;	
	
	Если Объект.Товары.Количество() > 0
		И ЗначениеЗаполнено(Объект.Товары[0].Номенклатура) Тогда		
		
		Объект.Номенклатура = Объект.Товары[0].Номенклатура;
		
		Если ЗначениеЗаполнено(Объект.Номенклатура) Тогда			
			
			Серия = Объект.Товары[0].СерияНоменклатуры;
			Объект.Цена    = Объект.Товары[0].Цена;
			Объект.Валюта  = ПредопределенноеЗначение("Справочник.Валюты.ОсновнаяВалюта");
			Объект.Валюта2 = Объект.Валюта;
			
			Если Объект.цена = 0 Тогда
				Объект.Цена = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Объект.Номенклатура, Объект.ВидЦен, Объект.Дата, ИСТИНА, , , , , , , Объект.Товары[0].ЕдиницаИзмерения);
				Если Объект.цена = 0 тогда
					Объект.Цена = Объект.Товары[0].Цена;	
					Если Объект.цена = 0 тогда
						Объект.Цена = Объект.Номенклатура.Цена;	
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(Объект.ВидЦен) Тогда
				Объект.Валюта = Объект.ВидЦен.ВалютаЦены;
			КонецЕсли;
			
			Объект.Цена2   = 0;
			Объект.ВидЦен2 = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ВторойВидЦенДляЭтикетки");
			Если ЗначениеЗаполнено(Объект.ВидЦен2) Тогда
				Объект.Цена2   = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Объект.Номенклатура, Объект.ВидЦен2, Объект.Дата, , , , , , , , Объект.Товары[0].ЕдиницаИзмерения);
				Объект.Валюта2 = Объект.ВидЦен2.ВалютаЦены;
			КонецЕсли;			
			
			Объект.Цена3   = 0;
			Объект.ВидЦен3 = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ТретийВидЦенДляФормул");
			Если ЗначениеЗаполнено(Объект.ВидЦен3) Тогда
				Объект.Цена3   = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Объект.Номенклатура, Объект.ВидЦен3, Объект.Дата, , , , , , , , Объект.Товары[0].ЕдиницаИзмерения);
				Объект.Валюта3 = Объект.ВидЦен3.ВалютаЦены;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(Объект.ОсновнаяФормулаТекстаЭтикетки) Тогда
				Попытка 				
					Объект.НоменклатурнаяГруппа = Объект.Номенклатура.НоменклатурнаяГруппа;
					Объект.Производитель 		= Объект.Номенклатура.производитель; 				
					
					Цена	= Объект.Цена;
					Цена2 	= Объект.Цена2;
					ВидЦен2 = Объект.ВидЦен2;
					Валюта2 = Объект.Валюта2;
					
					Цена3 	= Объект.Цена3;
					ВидЦен3 = Объект.ВидЦен3;
					Валюта3 = Объект.Валюта3;
					
					Валюта  = Объект.Валюта;
					ВидЦен 	= Объект.ВидЦен;
					Дата 	= Объект.Дата;
					Группа 	= Объект.Номенклатура.Родитель;
					Серия   = Объект.СерияНоменклатуры;
					Склад 	= Объект.Склад;
					ШтрихКод= Объект.ШтрихКод;
					Номенклатура = ОБъект.Номенклатура;
					НоменклатурнаяГруппа = Объект.НоменклатурнаяГруппа;
					Производитель  		 = Объект.Производитель;
					СерияНоменклатуры	 = Объект.СерияНоменклатуры;
					ТекстСШтрихКодом	 = Объект.ТекстСШтрихКодом;
					Наименование		 = Объект.Наименование;
					Количество			 = Объект.Количество;
					ЕдиницаИзмерения	 = Объект.ЕдиницаИзмерения;
					ДополнительнаяСтрокаЭтикетки = Объект.ДополнительнаяСтрокаЭтикетки;				
					
					Выполнить(" ПримерТекстаСШтрихКодом = """" + " + Объект.ОсновнаяФормулаТекстаЭтикетки.Формула + ";");
					
				Исключение 	
					ТекстОписаниеОшибки = ОписаниеОшибки();
					Сообщение = Новый СообщениеПользователю;
					Сообщение.Текст = ОбщийМодульПовтор.ПолучитьТекстНаЯзыке("Произошла ошибка") + ": " + ТекстОписаниеОшибки;
					Сообщение.Поле 	= "ОсновнаяФормулаТекстаЭтикетки";
					Сообщение.УстановитьДанные(Объект);
					Сообщение.Сообщить();
					
				КонецПопытки;	
			КонецЕсли;
			
		Иначе
			Если ЗначениеЗаполнено(Объект.ШтрихКод) Тогда
				ПримерТекстаСШтрихКодом = Объект.ШтрихКод;
			Иначе
				ПримерТекстаСШтрихКодом = " " + формат(Объект.цена, "ЧЦ=10; ЧДЦ=2") + " " + ?(ЗначениеЗаполнено(Объект.ВидЦен), Объект.ВидЦен.ВалютаЦены, Объект.Валюта);
			КонецЕсли;
			
		КонецЕсли;				
	КонецЕсли;	
	
КонецПроцедуры

&Насервере
Процедура ОбновитьТекстаЗаголовкаЭтикетки()
	
	//выполняется безусловно для расчета допреквизитов типа цена3 даже не для формул, а проверка и выполнение формулы ниже внутри
	ТекстЗаголовка = "";
	
	Попытка 
		Если значениезаполнено(Объект.Номенклатура) Тогда
			Номенклатура = Объект.Номенклатура;
		ИначеЕсли НЕ ПустаяСтрока(Объект.ШтрихКод) ТОгда
			Объект.Номенклатура = ОбщийМодульТоварСервер.ПолучитьНоменклатуруПоШтрихКоду(Объект.ШтрихКод, , ИСТИНА);	
			Номенклатура = Объект.Номенклатура;
		КонецЕсли;
		
		Если значениезаполнено(Объект.Номенклатура) Тогда
			Объект.Валюта  = ПредопределенноеЗначение("Справочник.Валюты.ОсновнаяВалюта");
			Объект.Валюта2 = Объект.Валюта;
			Если ВестиУчетСерийНоменклатуры Тогда
				Серия = ?(ЗначениеЗаполнено(Объект.СерияСуществующейНоменклатуры), Объект.СерияСуществующейНоменклатуры.Наименование, Объект.СерияНоменклатуры);
			КонецЕсли;
			
			Если ЗначениеЗаполнено(Объект.ВидЦен) Тогда
				Объект.Валюта = Объект.ВидЦен.ВалютаЦены;
			КонецЕсли;
			
			Цена = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Объект.Номенклатура, Объект.ВидЦен, Объект.Дата, , , , , , , , Объект.ЕдиницаИзмерения);
			Если Объект.Цена = 0 Тогда
				Цена = Объект.Цена;
			Иначе
				Объект.Цена = Цена;
			КонецЕсли;
			
			Объект.Цена2   = 0;
			Объект.ВидЦен2 = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ВторойВидЦенДляЭтикетки");
			Если ЗначениеЗаполнено(Объект.ВидЦен2) Тогда
				Объект.Цена2   = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Объект.Номенклатура, Объект.ВидЦен2, Объект.Дата, , , , , , , , Объект.ЕдиницаИзмерения);
				Объект.Валюта2 = Объект.ВидЦен2.ВалютаЦены;
			КонецЕсли;
			
			Объект.Цена3   = 0;
			Объект.ВидЦен3 = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ТретийВидЦенДляФормул");
			Если ЗначениеЗаполнено(Объект.ВидЦен3) Тогда
				Объект.Цена3   = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Объект.Номенклатура, Объект.ВидЦен3, Объект.Дата, , , , , , , , Объект.ЕдиницаИзмерения);
				Объект.Валюта3 = Объект.ВидЦен3.ВалютаЦены;
			КонецЕсли;
			
			Цена	= Объект.Цена;
			Цена2 	= Объект.Цена2;
			ВидЦен2 = Объект.ВидЦен2;
			Валюта2 = Объект.Валюта2;
			
			Цена3 	= Объект.Цена3;
			ВидЦен3 = Объект.ВидЦен3;
			Валюта3 = Объект.Валюта3;
			
			Валюта  = Объект.Валюта;
			ВидЦен 	= Объект.ВидЦен;
			Дата 	= Объект.Дата;
			Группа 	= Объект.Номенклатура.Родитель;
			Склад 	= Объект.Склад;
			ШтрихКод= Объект.ШтрихКод;
			Номенклатура = ОБъект.Номенклатура;
			НоменклатурнаяГруппа = Объект.НоменклатурнаяГруппа;
			Производитель  		 = Объект.Производитель;
			СерияНоменклатуры	 = Объект.СерияНоменклатуры;
			ТекстСШтрихКодом	 = Объект.ТекстСШтрихКодом;
			Наименование		 = Объект.Наименование;
			Количество			 = Объект.Количество;
			ЕдиницаИзмерения	 = Объект.ЕдиницаИзмерения;
			ДополнительнаяСтрокаЭтикетки = Объект.ДополнительнаяСтрокаЭтикетки;
			
			Если ИспользуютсяФормулы 
				И ЗначениеЗаполнено(Объект.ФормулаТекстаЗаголовка) Тогда
				
				Выполнить(" ТекстЗаголовка = """"+" + Объект.ФормулаТекстаЗаголовка.Формула + ";");	
			КонецЕсли;
			
			Если НЕ Объект.ТекстЗаголовка = ТекстЗаголовка Тогда
				Объект.ТекстЗаголовка = ТекстЗаголовка;
			КонецЕсли;	
		КонецЕсли;
		
	Исключение 	
		ТекстОписаниеОшибки = ОписаниеОшибки();
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = ОбщийМодульПовтор.ПолучитьТекстНаЯзыке("Произошла ошибка") + ": " + ТекстОписаниеОшибки;
		Сообщение.Поле 	= "ФормулаТекстаЗаголовка";
		Сообщение.УстановитьДанные(Объект);
		Сообщение.Сообщить();
		
	КонецПопытки;
	
конецпроцедуры

&НаСервере
Функция   ОбщееКоличество() 
	
	Объект.Количество = Объект.Товары.Итог("Количество");
	Возврат Объект.Количество;
	
КонецФункции // ОбщееКоличество

&НаСервере
Функция   ОбщийМодульСерверНапечататьЭтикетку(Знач ШтрихКод, Знач ТекстСШтрихКодом, Знач Количество = 1, Знач Табдок = Неопределено, Знач КолонокВСтрокеПечати = 0)
	
	Если Табдок = Неопределено Тогда
		Табдок = Новый ТабличныйДокумент;
		Табдок.ИмяПараметровПечати  = "ЭТИК" + СокрЛП(ИмяКомпьютера());
		ТабДок.КлючПараметровПечати = ТабДок.ИмяПараметровПечати;
	КонецЕсли;
	
	СтруктураПечати = Новый Структура;
	СтруктураПечати.Вставить("ШтрихКод", ШтрихКод);
	СтруктураПечати.Вставить("ТипШтрихКода", Объект.ТипШтрихКода);
	СтруктураПечати.Вставить("ТекстСШтрихКодом", ТекстСШтрихКодом);
	СтруктураПечати.Вставить("Количество", Количество);
	СтруктураПечати.Вставить("ТекстЗаголовка", Объект.ТекстЗаголовка);
	СтруктураПечати.Вставить("ДополнительнаяСтрокаЭтикетки", Объект.ДополнительнаяСтрокаЭтикетки);
	СтруктураПечати.Вставить("ВсеПараметрыПечати", ОбщийМодульТекстСервер.ПолучитьВсеПараметрыПечатиОбъекта(Объект, "Обработки", "ПечатьЭтикетки"));
	СтруктураПечати.Вставить("ПроизвольнаяПечатнаяФорма", Объект.ПроизвольнаяПечатнаяФорма);
	СтруктураПечати.Вставить("КолонокВСтрокеПечати", КолонокВСтрокеПечати);
	
	ОбщийМодульТоварСервер.НапечататьЭтикетку(СтруктураПечати, ТабДок, ЛОЖЬ, ИСТИНА);
	
	Возврат ТабДок;
	
КонецФункции

&НаКлиенте
Процедура ОсновнаяФормулаТекстаЭтикеткиПриИзменении(Элемент)
	ОсновнаяФормулаТекстаЭтикеткиПриИзмененииНаСервере();
КонецПроцедуры

&НаСервере
Процедура ОсновнаяФормулаТекстаЭтикеткиПриИзмененииНаСервере()
	ОбновитьПримеры();
КонецПроцедуры

&Насервере
Функция   ПолучитьТекстЗаголовка(Знач Номенклатура, Знач Цена, Знач ШтрихКод, Знач СерияНоменклатуры)
	
	ТекстЗаголовка = Объект.ТекстЗаголовка;
	
	Если ЗначениеЗаполнено(Номенклатура)
		И ИспользуютсяФормулы
		И ЗначениеЗаполнено(Объект.ФормулаТекстаЗаголовка) Тогда
		
		Попытка
			Объект.Валюта  = ПредопределенноеЗначение("Справочник.Валюты.ОсновнаяВалюта");
			Объект.Валюта2 = Объект.Валюта;
			Объект.НоменклатурнаяГруппа = Номенклатура.НоменклатурнаяГруппа;
			Объект.Производитель  		= Номенклатура.Производитель;
			Объект.СерияНоменклатуры 	= СерияНоменклатуры;
			Серия = сокрлп(Объект.СерияНоменклатуры);
			
			Если ЗначениеЗаполнено(Объект.ВидЦен) Тогда
				Объект.Валюта = Объект.ВидЦен.ВалютаЦены;
			КонецЕсли;
			
			Объект.Цена2   = 0;
			Объект.ВидЦен2 = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ВторойВидЦенДляЭтикетки");
			Если ЗначениеЗаполнено(Объект.ВидЦен2) Тогда
				Объект.Цена2   = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Объект.Номенклатура, Объект.ВидЦен2, Объект.Дата, ЛОЖЬ);
				Объект.Валюта2 = Объект.ВидЦен2.ВалютаЦены;
			КонецЕсли;
			
			Объект.Цена3   = 0;
			Объект.ВидЦен3 = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ТретийВидЦенДляФормул");
			Если ЗначениеЗаполнено(Объект.ВидЦен3) Тогда
				Объект.Цена3   = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Объект.Номенклатура, Объект.ВидЦен3, Объект.Дата, ЛОЖЬ);
				Объект.Валюта3 = Объект.ВидЦен3.ВалютаЦены;
			КонецЕсли;
			
			Цена	= Объект.Цена;
			Цена2 	= Объект.Цена2;
			ВидЦен2 = Объект.ВидЦен2;
			Валюта2 = Объект.Валюта2;
			
			Цена3 	= Объект.Цена3;
			ВидЦен3 = Объект.ВидЦен3;
			Валюта3 = Объект.Валюта3;
			
			Валюта  = Объект.Валюта;
			ВидЦен 	= Объект.ВидЦен;
			Дата 	= Объект.Дата;
			Группа 	= Объект.Номенклатура.Родитель;
			Склад 	= Объект.Склад;
			ШтрихКод= Объект.ШтрихКод;
			Номенклатура = ОБъект.Номенклатура;
			НоменклатурнаяГруппа = Объект.НоменклатурнаяГруппа;
			Производитель  		 = Объект.Производитель;
			СерияНоменклатуры	 = Объект.СерияНоменклатуры;
			ТекстСШтрихКодом	 = Объект.ТекстСШтрихКодом;
			Наименование		 = Объект.Наименование;
			Количество			 = Объект.Количество;
			ЕдиницаИзмерения	 = Объект.ЕдиницаИзмерения;
			ДополнительнаяСтрокаЭтикетки = Объект.ДополнительнаяСтрокаЭтикетки;
			
			Выполнить(" ТекстЗаголовка = """"+" + Объект.ФормулаТекстаЗаголовка.Формула + ";");
			
		Исключение 	
			ТекстОписаниеОшибки = ОписаниеОшибки();
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = ОбщийМодульПовтор.ПолучитьТекстНаЯзыке("Произошла ошибка") + ": " + ТекстОписаниеОшибки;
			Сообщение.Поле 	= "ФормулаТекстаЗаголовка";
			Сообщение.УстановитьДанные(Объект);
			Сообщение.Сообщить();
			
		КонецПопытки;
		
	КонецЕсли;
	
	возврат ТекстЗаголовка;
	
конецФункции

&Насервере
Функция   ПолучитьДополнительнуюСтрокуЭтикетки(Знач Номенклатура, Знач Цена, Знач ШтрихКод, Знач СерияНоменклатуры)
	
	ТекстЗаголовка = Объект.ДополнительнаяСтрокаЭтикетки;
	
	Если ЗначениеЗаполнено(Номенклатура)
		И ИспользуютсяФормулы
		И ЗначениеЗаполнено(ФормулаДополнительнойСтроки) Тогда
		
		Попытка
			Объект.Валюта  = ПредопределенноеЗначение("Справочник.Валюты.ОсновнаяВалюта");
			Объект.Валюта2 = Объект.Валюта;
			Объект.НоменклатурнаяГруппа 	= Номенклатура.НоменклатурнаяГруппа;
			Объект.Производитель  			= Номенклатура.Производитель;
			Объект.СерияНоменклатуры 		= СерияНоменклатуры;
			Серия = Сокрлп(Объект.СерияНоменклатуры);
			
			Если ЗначениеЗаполнено(Объект.ВидЦен) Тогда
				Объект.Валюта = Объект.ВидЦен.ВалютаЦены;
			КонецЕсли;
			
			Объект.Цена2   = 0;
			Объект.ВидЦен2 = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ВторойВидЦенДляЭтикетки");
			Если ЗначениеЗаполнено(Объект.ВидЦен2) Тогда
				Объект.Цена2   = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Объект.Номенклатура, Объект.ВидЦен2, Объект.Дата, ЛОЖЬ);
				Объект.Валюта2 = Объект.ВидЦен2.ВалютаЦены;
			КонецЕсли;
			
			Объект.Цена3   = 0;
			Объект.ВидЦен3 = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ТретийВидЦенДляФормул");
			Если ЗначениеЗаполнено(Объект.ВидЦен3) Тогда
				Объект.Цена3   = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Объект.Номенклатура, Объект.ВидЦен3, Объект.Дата, ЛОЖЬ);
				Объект.Валюта3 = Объект.ВидЦен3.ВалютаЦены;
			КонецЕсли;
			
			Цена	= Объект.Цена;
			Цена2 	= Объект.Цена2;
			ВидЦен2 = Объект.ВидЦен2;			
			Валюта2 = Объект.Валюта2;
			
			Цена3 	= Объект.Цена3;
			ВидЦен3 = Объект.ВидЦен3;
			Валюта3 = Объект.Валюта3;
			
			Валюта  = Объект.Валюта;
			ВидЦен 	= Объект.ВидЦен;
			Дата 	= Объект.Дата;
			Группа 	= Объект.Номенклатура.Родитель;
			Склад 	= Объект.Склад;
			ШтрихКод= Объект.ШтрихКод;
			Номенклатура = ОБъект.Номенклатура;
			НоменклатурнаяГруппа = Объект.НоменклатурнаяГруппа;
			Производитель  		 = Объект.Производитель;
			СерияНоменклатуры	 = Объект.СерияНоменклатуры;
			ТекстСШтрихКодом	 = Объект.ТекстСШтрихКодом;
			Наименование		 = Объект.Наименование;
			Количество			 = Объект.Количество;
			ЕдиницаИзмерения	 = Объект.ЕдиницаИзмерения;
			ДополнительнаяСтрокаЭтикетки = Объект.ДополнительнаяСтрокаЭтикетки;
			
			Выполнить(" ТекстЗаголовка = """"+" + ФормулаДополнительнойСтроки.Формула + ";");
			
		Исключение 	
			ТекстОписаниеОшибки = ОписаниеОшибки();
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = ОбщийМодульПовтор.ПолучитьТекстНаЯзыке("Произошла ошибка") + ": " + ТекстОписаниеОшибки;
			Сообщение.Поле 	= "ФормулаДополнительнойСтроки";
			Сообщение.УстановитьДанные(Объект);
			Сообщение.Сообщить();
			
		КонецПопытки;
		
	КонецЕсли;
	
	возврат ТекстЗаголовка;
	
конецФункции

&Насервере
Функция   ПолучитьТекстСШтрихКодомТовара(Знач Номенклатура, Знач Цена, Знач ШтрихКод, Знач СерияНоменклатуры, Знач ЕдиницаИзмерения)
	
	ТекстСШтрихКодом = "";
	
	Если ЗначениеЗаполнено(Номенклатура)
		И ИспользуютсяФормулы
		И ЗначениеЗаполнено(Объект.ОсновнаяФормулаТекстаЭтикетки) Тогда
		
		Попытка
			Объект.Валюта  = ПредопределенноеЗначение("Справочник.Валюты.ОсновнаяВалюта");
			Объект.Валюта2 = Объект.Валюта;
			Объект.НоменклатурнаяГруппа = Номенклатура.НоменклатурнаяГруппа;
			Объект.Производитель  		 = Номенклатура.Производитель;
			Объект.СерияНоменклатуры 	 = СерияНоменклатуры;
			Серия = сокрлп(Объект.СерияНоменклатуры);
			
			Если ЗначениеЗаполнено(Объект.ВидЦен) Тогда
				Объект.Валюта = Объект.ВидЦен.ВалютаЦены;
			КонецЕсли;
			
			Объект.Цена2   = 0;
			Объект.ВидЦен2 = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ВторойВидЦенДляЭтикетки");
			Если ЗначениеЗаполнено(Объект.ВидЦен2) Тогда
				Объект.Цена2   = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Объект.Номенклатура, Объект.ВидЦен2, Объект.Дата, , , , , , , , ЕдиницаИзмерения);
				Объект.Валюта2 = Объект.ВидЦен2.ВалютаЦены;
			КонецЕсли;
			
			Объект.Цена3   = 0;
			Объект.ВидЦен3 = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ТретийВидЦенДляФормул");
			Если ЗначениеЗаполнено(Объект.ВидЦен3) Тогда
				Объект.Цена3   = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Объект.Номенклатура, Объект.ВидЦен3, Объект.Дата, , , , , , , , ЕдиницаИзмерения);
				Объект.Валюта3 = Объект.ВидЦен3.ВалютаЦены;
			КонецЕсли;
			
			Цена	= Объект.Цена;
			Цена2 	= Объект.Цена2;
			ВидЦен2 = Объект.ВидЦен2;
			Валюта2 = Объект.Валюта2;
			
			Цена3 	= Объект.Цена3;
			ВидЦен3 = Объект.ВидЦен3;
			Валюта3 = Объект.Валюта3;
			
			Валюта  = Объект.Валюта;
			ВидЦен 	= Объект.ВидЦен;
			Дата 	= Объект.Дата;
			Группа 	= Объект.Номенклатура.Родитель;
			Склад 	= Объект.Склад;
			ШтрихКод= Объект.ШтрихКод;
			Номенклатура = ОБъект.Номенклатура;
			НоменклатурнаяГруппа = Объект.НоменклатурнаяГруппа;
			Производитель  		 = Объект.Производитель;
			СерияНоменклатуры	 = Объект.СерияНоменклатуры;
			ТекстСШтрихКодом	 = Объект.ТекстСШтрихКодом;
			Наименование		 = Объект.Наименование;
			Количество			 = Объект.Количество;
			ЕдиницаИзмерения	 = Объект.ЕдиницаИзмерения;
			ДополнительнаяСтрокаЭтикетки = Объект.ДополнительнаяСтрокаЭтикетки;
			
			Выполнить(" ТекстСШтрихКодом = """"+" + Объект.ОсновнаяФормулаТекстаЭтикетки.Формула + ";");
			
		Исключение 	
			ТекстОписаниеОшибки = ОписаниеОшибки();
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = ОбщийМодульПовтор.ПолучитьТекстНаЯзыке("Произошла ошибка") + ": " + ТекстОписаниеОшибки;
			Сообщение.Поле 	= "ОсновнаяФормулаТекстаЭтикетки";
			Сообщение.УстановитьДанные(Объект);
			Сообщение.Сообщить();
			
		КонецПопытки;
		
	Иначе 		
		Если НЕ ПустаяСтрока(ШтрихКод) тогда
			ТекстСШтрихКодом = ШтрихКод;
		Иначе
			ТекстСШтрихКодом = ОбщийМодульПовтор.получитьПредставлениеНаЯзыке(Номенклатура) + " " + формат(Цена, "ЧЦ=12; ЧДЦ=2");
		КонецЕсли;
		
		Если ВестиУчетСерийНоменклатуры
			И ЗначениеЗаполнено(СерияНоменклатуры) Тогда
			
			ТекстСШтрихКодом = ТекстСШтрихКодом + " " + СерияНоменклатуры;
		КонецЕсли;
		
	КонецЕсли;
	
	возврат ТекстСШтрихКодом;
	
конецФункции

&НаСервере
Функция   ПолучитьШтрихКодТовара(Знач Номенклатура, Знач Цена, Знач СерияНоменклатуры, Знач ЕдиницаИзмерения)
	
	Объект.Номенклатура = Номенклатура;
	Объект.Цена = Цена;
	Объект.СерияСуществующейНоменклатуры = СерияНоменклатуры;
	
	ШтрихКод = "";
	Если ИспользуютсяФормулы
		И ЗначениеЗаполнено(Объект.ФормулаФормированияШтрихКода) Тогда
		
		Если ЗначениеЗаполнено(Номенклатура) Тогда
			Объект.НоменклатурнаяГруппа = Номенклатура.НоменклатурнаяГруппа;
			Объект.Производитель 		= Номенклатура.Производитель;
			
			Если ОбщийМодульПовтор.ВывестиНаименованияНаДругомЯзыке() Тогда
				
				ВозможноеПредставление = ОбщийМодульПовтор.получитьПредставлениеНаЯзыке(Номенклатура, , ИСТИНА);
				Если НЕ ВозможноеПредставление = Неопределено Тогда
					Объект.Наименование = ВозможноеПредставление;
				Иначе
					Объект.Наименование = Номенклатура.Наименование;
				КонецЕсли;
			Иначе
				Объект.Наименование 	= Номенклатура.Наименование;
			КонецЕсли;
			
			Объект.СерияНоменклатуры	= СокрЛП(СерияНоменклатуры);
		КонецЕсли;
		
		ШтрихКод = "";
		
		Попытка 
			
			Если ЗначениеЗаполнено(Номенклатура.Производитель) 
				И ЗначениеЗаполнено(Номенклатура.Производитель.СвояФормулаШтрихКодаНоменклатуры) Тогда			
				
				ШтрихКод = ОбщийМодульТоварСервер.УстановитьШтрихКодНоменклатурыПоФормуле(Номенклатура, , Объект.ВидЦен, Объект.Дата, Объект.Цена, СерияНоменклатуры, ЕдиницаИзмерения);
				
			Иначе
				ШтрихКод = ОбщийМодульТоварСервер.УстановитьШтрихКодНоменклатурыПоФормуле(Номенклатура, Объект.ФормулаФормированияШтрихКода.Формула, Объект.ВидЦен, Объект.Дата, Объект.Цена, СерияНоменклатуры, ЕдиницаИзмерения);
			КонецЕсли;			
			
		Исключение 				
			ТекстОписаниеОшибки = ОписаниеОшибки();
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = ОбщийМодульПовтор.ПолучитьТекстНаЯзыке("Произошла ошибка") + ": " + ТекстОписаниеОшибки;
			Сообщение.Поле 	= "ФормулаФормированияШтрихКода";
			Сообщение.УстановитьДанные(Объект);
			Сообщение.Сообщить();
			
		КонецПопытки;
		
	Иначеесли ВестиУчетСерийНоменклатуры
		И ЗначениеЗаполнено(СерияНоменклатуры) тогда
		
		ШтрихКод = ОбщийМодульТоварСервер.ПолучитьШтрихКодСерии(СерияНоменклатуры);
		Если ПустаяСтрока(ШтрихКод) Тогда
			ШтрихКод = Номенклатура.ОсновнойШтрихКод;
		КонецЕсли;
		
	Иначеесли значениезаполнено(Объект.Номенклатура) Тогда
		ШтрихКод = Номенклатура.ОсновнойШтрихКод;
		
	КонецЕсли;
	
	возврат ШтрихКод;
	
КонецФункции

&НаКлиенте
Процедура ПриЗакрытии()                                       // ПРИ ЗАКРЫТИИ
	
	ОбщийМодульКлиент.СобытиеФормы(ЭтаФорма, 1);
	
	Если ИспользоватьПодключаемоеОборудование Тогда
		ПоддерживаемыеТипыВО = Новый Массив ();
		ПоддерживаемыеТипыВО.Добавить("СчитывательМагнитныхКарт");
		ПоддерживаемыеТипыВО.Добавить("СканерШтрихКода");
		ПоддерживаемыеТипыВО.Добавить("ДисплейПокупателя");
		МенеджерОборудованияКлиент.ОтключитьОборудованиеПоТипу(УникальныйИдентификатор, ПоддерживаемыеТипыВО);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)                                  // ПРИ ОТКРЫТИИ	
	
	ОбщийМодульКлиент.СобытиеФормы(ЭтаФорма, 0);
	
	ПроверитьФормулы();
	ОпределитьПроизвольнуюПечатнуюФорму();
	
	Если ИспользоватьПодключаемоеОборудование И 
		МенеджерОборудованияКлиент.ОбновитьРабочееМестоКлиента() Тогда
		
		ОписаниеОшибки = "" ;
		ПоддерживаемыеТипыВО = Новый Массив();
		ПоддерживаемыеТипыВО.Добавить("СчитывательМагнитныхКарт");
		ПоддерживаемыеТипыВО.Добавить("СканерШтрихКода");
		ПоддерживаемыеТипыВО.Добавить("ДисплейПокупателя");
		
		Если НЕ МенеджерОборудованияКлиент.ПодключитьОборудованиеПоТипу(УникальныйИдентификатор, ПоддерживаемыеТипыВО, ОписаниеОшибки) Тогда
			ТекстСообщения = ОбщийМодульПовтор.ПолучитьТекстНаЯзыке( "При подключении оборудования произошла ошибка") + ": " + ОписаниеОшибки + ".";
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)   // ПРИ СОЗДАНИИ НА СЕРВЕРЕ
	
	Отказ = ОбщийМодульСервисСервер.ПроверитьОтказДоступа("000200", ЭтаФорма, Отказ, );
	
	Если НЕ Отказ Тогда
		Если ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ИспользоватьСобственныйПереводЭлементовИнтерфейса") Тогда
			ОбщийМодульСервер.ПеревестиРеквизитыФормы(ЭтаФорма);	
		КонецЕсли;
		
		ИспользуютсяФормулы 			= ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ИспользоватьФормулыАвтоНаименованияФормированияШтрихКодаИТекстаСШтрихКодом");
		ИспользоватьСкидки				= ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ИспользоватьСкидки");
		ИспользоватьСложныйМеханизмЦен 	= ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ИспользоватьСложныйМеханизмЦен");
		Элементы.Дата.Видимость			= ИспользоватьСложныйМеханизмЦен;
		ИспользоватьПроизвольныеПечатныеФормы 		= ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ИспользоватьПроизвольныеПечатныеФормы");
		Элементы.ТоварыПодборНоменклатуры.Видимость = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ВключитьМеханизмПодбораНоменклатуры");
		
		ВестиУчетСерийНоменклатуры 	= параметрысеанса.ВестиУчетПоСериямНоменклатуры
		ИЛИ ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ВестиУчетСерийНоменклатурыТолькоПриПоступлении");
		
		ВывестиДополнительнуюСтрокуЭтикетки	 = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ВывестиДополнительнуюСтрокуЭтикетки");
		
		Элементы.ФормулаДополнительнойСтроки.Видимость = ИспользуютсяФормулы И ВывестиДополнительнуюСтрокуЭтикетки;
		ФормулаДополнительнойСтроки = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ФормулаДополнительнойСтрокиЭтикетки");
		Элементы.ФормулаДополнительнойСтроки.Видимость = ВывестиДополнительнуюСтрокуЭтикетки;
		Объект.ДополнительнаяСтрокаЭтикетки = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ДополнительнаяСтрокаЭтикетки");	
		
		Этаформа.Заголовок = ОбщийМодульПовтор.ПолучитьТекстНаЯзыке("Печать этикеток для таблицы товаров документа") + ": " + Параметры.ДокументСТаблицей;
		
		Если ИспользоватьСложныйМеханизмЦен Тогда
			Попытка 
				Если ЗначениеЗаполнено(Параметры.ДокументСТаблицей) Тогда
					Объект.ВидЦен = Параметры.ДокументСТаблицей.ВидЦен;	
					Объект.Дата   = Параметры.ДокументСТаблицей.Дата + 1; //плюс секунда для учета установленных документом цен и прочего
				КонецЕсли;
				
			Исключение 	
			КонецПопытки;
			
			Если НЕ ЗначениеЗаполнено(Объект.ВидЦен) Тогда
				Объект.ВидЦен = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ВидЦенРасходованияПоУмолчанию");
				
				Если НЕ ЗначениеЗаполнено(Объект.ВидЦен) Тогда
					Объект.ВидЦен = ПредопределенноеЗначение("Справочник.ВидыЦен.ГлавныйВидЦен");
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		ДокументСТаблицей = Параметры.ДокументСТаблицей;
		Объект.Товары.Очистить();
		Если ТипЗнч(ДокументСТаблицей) = Тип("ДокументСсылка.Инвентаризации") Тогда		
			
			Для Каждого ТоварыДокумента Из ДокументСТаблицей.Товары Цикл
				
				ТоварыСтарока = Объект.Товары.Добавить();
				ТоварыСтарока.Номенклатура = ТоварыДокумента.Номенклатура;
				Если ЗначениеЗаполнено(ТоварыДокумента.КоличествоПоФакту) Тогда
					ТоварыСтарока.Количество 	= ТоварыДокумента.КоличествоПоФакту;
					ТоварыСтарока.Сумма 		= ТоварыДокумента.СуммаПоФакту;
				Иначе
					ТоварыСтарока.Количество 	= ТоварыДокумента.КоличествоУчет;
					ТоварыСтарока.Сумма 		= ТоварыДокумента.СуммаУчет;
				КонецЕсли;			
				ТоварыСтарока.Цена = ТоварыДокумента.Цена;
				
			КонецЦикла;
			
		ИначеЕсли ЗначениеЗаполнено(ДокументСТаблицей) Тогда			
			Попытка
			Объект.Дата = Параметры.ДокументСТаблицей.Дата + 1; //плюс секунда для учета установленных документом цен и прочего
			Объект.Товары.Загрузить(ДокументСТаблицей.Товары.Выгрузить());	
				Клиент = ДокументСТаблицей.КлиентПоставщик;
				Если ЗначениеЗаполнено(Клиент)
					И ТипЗнч(Клиент) = Тип("СправочникСсылка.Клиенты") Тогда
					
					Объект.ОсновнаяФормулаТекстаЭтикетки = Клиент.ФормулаТекстаЭтикетки;
				КонецЕсли;
				
			Исключение // для перемещения товара
			КонецПопытки;
		КонецЕсли;		
		
		Если НЕ ЗначениеЗаполнено(Объект.ОсновнаяФормулаТекстаЭтикетки) Тогда
			Попытка 
				Объект.Склад = Параметры.ДокументСТаблицей.СкладКуда;
				Если ЗначениеЗаполнено(Объект.Склад) Тогда
					Объект.ОсновнаяФормулаТекстаЭтикетки = Объект.склад.ФормулаТекстаЭтикетки;
				КонецЕсли;
			Исключение 	
			КонецПопытки;
			
			Если НЕ ЗначениеЗаполнено(Объект.ОсновнаяФормулаТекстаЭтикетки) Тогда
				Попытка 
					Объект.Склад = Параметры.ДокументСТаблицей.Склад;
					Если ЗначениеЗаполнено(Объект.Склад) Тогда
						Объект.ОсновнаяФормулаТекстаЭтикетки = Объект.склад.ФормулаТекстаЭтикетки;
					КонецЕсли;
				Исключение 	
				КонецПопытки;
			КонецЕсли;
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(Объект.Склад)
			И ЗначениеЗаполнено(Параметры.ДокументСТаблицей) Тогда
			
			Попытка 
				Объект.Склад = Параметры.ДокументСТаблицей.Склад;
			Исключение 	
			КонецПопытки;	
		КонецЕсли;
		
		Если параметрысеанса.НеМожетМенятьЦены  тогда
			Если ЗначениеЗаполнено(Объект.ВидЦен) Тогда			
				Элементы.ВидЦен.Доступность = ЛОЖЬ;			
			КонецЕсли;
			Элементы.ТоварыЦена.Доступность = ЛОЖЬ;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Параметры.Склад) Тогда
			Объект.Склад = Параметры.Склад;
		КонецЕсли;
		Если ЗначениеЗаполнено(Параметры.Дата) Тогда
			Объект.Дата = Параметры.Дата;
		КонецЕсли;
		
		Если Объект.Дата = '00010101000000'  Тогда
			Объект.Дата = ОбщийМодульСервисСервер.ПользователяТекущаяДата();
		КонецЕсли;
		
		ПропорцияЭтикетки = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ФорматЭтикетки");	
		ИмяПринтера = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("НаименованиеПринтераШтрихКодов");
		Элементы.ИмяПринтера.Видимость = ЗначениеЗаполнено(ИмяПринтера);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьФормулуТекстаЗаголовка(Команда)
	ПроверитьФормулуТекстаЗаголовкаНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПроверитьФормулуТекстаЗаголовкаНаСервере()
	
	Если ЗначениеЗаполнено(Объект.ФормулаТекстаЗаголовка) Тогда
		ОбщийМодульСервер.ПроверитьФормулу(Объект.ФормулаТекстаЗаголовка.Формула);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьФормулуТекстаЭтикетки(Команда)
	ПроверитьФормулуТекстаЭтикеткиНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПроверитьФормулуТекстаЭтикеткиНаСервере()
	
	Если ЗначениеЗаполнено(Объект.ОсновнаяФормулаТекстаЭтикетки) Тогда
		ОбщийМодульСервер.ПроверитьФормулу(Объект.ОсновнаяФормулаТекстаЭтикетки.Формула);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьФормулуШтрихКода(Команда)
	ПроверитьФормулуШтрихКодаНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПроверитьФормулуШтрихКодаНаСервере()
	
	Если ЗначениеЗаполнено(Объект.ФормулаФормированияШтрихКода) Тогда
		ОбщийМодульСервер.ПроверитьФормулу(Объект.ФормулаФормированияШтрихКода.Формула);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПроверитьФормулы()
	
	Если НЕ ЗначениеЗаполнено(Объект.ФормулаФормированияШтрихКода) Тогда
		Объект.ФормулаФормированияШтрихКода = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ОсновнаяФормулаШтрихКодаНоменклатуры");	
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.ОсновнаяФормулаТекстаЭтикетки) Тогда
		Объект.ОсновнаяФормулаТекстаЭтикетки = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ОсновнаяФормулаТекстаЭтикетки");
	КонецЕсли;        	
	ОбновитьПримеры();
	
КонецПроцедуры

&НаСервере
Процедура сменитьценутаблицы()
	
	Для Каждого строкатаблицы из Объект.Товары цикл
		строкатаблицы.цена 	= ОбщийМодульСервер.ПолучитьЦенуНаСервере(строкатаблицы.Номенклатура, Объект.ВидЦен, Объект.Дата, ИСТИНА, строкатаблицы.количество, , , , , , строкатаблицы.ЕдиницаИзмерения);
		строкатаблицы.сумма = строкатаблицы.цена * строкатаблицы.количество;
	КонецЦикла;	
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыПриИзменении(Элемент)
	ТоварыПриИзмененииНаСервере();
КонецПроцедуры

&НаСервере
Процедура ТоварыПриИзмененииНаСервере()
	ОбновитьПримеры();
КонецПроцедуры

&НаКлиенте
Процедура ФормулаТекстаЗаголовкаПриИзменении(Элемент)
	ОбновитьТекстаЗаголовкаЭтикетки();
КонецПроцедуры

&НаКлиенте
Процедура ФормулаФормированияШтрихКодаПриИзменении(Элемент)
	ФормулаФормированияШтрихКодаПриИзмененииНаСервере();
КонецПроцедуры

&НаСервере
Процедура ФормулаФормированияШтрихКодаПриИзмененииНаСервере()
	ОбновитьПримеры();
КонецПроцедуры

&Насервере
Процедура ОбновитьТекстДополнительнойСтроки()
	
	Если ИспользуютсяФормулы 
		И ЗначениеЗаполнено(ФормулаДополнительнойСтроки) Тогда
		
		Если Объект.Товары.Количество() > 0
			И ЗначениеЗаполнено(Объект.Товары[0].Номенклатура) Тогда		
			
			ТекстЗаголовка = "";
			
			Попытка 
				Объект.Номенклатура = Объект.Товары[0].Номенклатура;
				
				Если ЗначениеЗаполнено(Объект.Номенклатура) Тогда
					Объект.Валюта  = ПредопределенноеЗначение("Справочник.Валюты.ОсновнаяВалюта");
					Объект.Валюта2 = Объект.Валюта;
					
					Если ВестиУчетСерийНоменклатуры Тогда
						Серия = ?(ЗначениеЗаполнено(Объект.Товары[0].СерияНоменклатуры), Объект.Товары[0].СерияНоменклатуры.Наименование, "");
					КонецЕсли;
					
					Если ЗначениеЗаполнено(Объект.ВидЦен) Тогда
						Объект.Валюта = Объект.ВидЦен.ВалютаЦены;
					КонецЕсли;
					
					Цена = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Объект.Номенклатура, Объект.ВидЦен, Объект.Дата, , , , , , , , Объект.Товары[0].ЕдиницаИзмерения);
					Если Цена = 0 Тогда
						Цена = Объект.Цена;
					Иначе
						Объект.Цена = Цена;
					КонецЕсли;
					
					Объект.Цена2   = 0;
					Объект.ВидЦен2 = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ВторойВидЦенДляЭтикетки");
					Если ЗначениеЗаполнено(Объект.ВидЦен2) Тогда
						Объект.Цена2   = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Объект.Номенклатура, Объект.ВидЦен2, Объект.Дата, , , , , , , , Объект.Товары[0].ЕдиницаИзмерения);
						Объект.Валюта2 = Объект.ВидЦен2.ВалютаЦены;
					КонецЕсли;			
					
					Объект.Цена3   = 0;
					Объект.ВидЦен3 = ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ТретийВидЦенДляФормул");
					Если ЗначениеЗаполнено(Объект.ВидЦен3) Тогда
						Объект.Цена3   = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Объект.Номенклатура, Объект.ВидЦен3, Объект.Дата, , , , , , , , Объект.Товары[0].ЕдиницаИзмерения);
						Объект.Валюта3 = Объект.ВидЦен3.ВалютаЦены;
					КонецЕсли;
					
					Цена	= Объект.Цена;
					Цена2 	= Объект.Цена2;
					ВидЦен2 = Объект.ВидЦен2;
					Валюта2 = Объект.Валюта2;
					
					Цена3 	= Объект.Цена3;
					ВидЦен3 = Объект.ВидЦен3;
					Валюта3 = Объект.Валюта3;
					
					Валюта  = Объект.Валюта;
					ВидЦен 	= Объект.ВидЦен;
					Дата 	= Объект.Дата;
					Группа 	= Объект.Номенклатура.Родитель;
					Склад 	= Объект.Склад;
					ШтрихКод= Объект.ШтрихКод;
					Номенклатура = ОБъект.Номенклатура;
					НоменклатурнаяГруппа = Объект.НоменклатурнаяГруппа;
					Производитель  		 = Объект.Производитель;
					СерияНоменклатуры	 = Объект.СерияНоменклатуры;
					ТекстСШтрихКодом	 = Объект.ТекстСШтрихКодом;
					Наименование		 = Объект.Наименование;
					Количество			 = Объект.Количество;
					ЕдиницаИзмерения	 = Объект.ЕдиницаИзмерения;
					ДополнительнаяСтрокаЭтикетки = Объект.ДополнительнаяСтрокаЭтикетки;
					
					Выполнить(" ТекстЗаголовка = """"+" + ФормулаДополнительнойСтроки.Формула + ";");
					
					Если НЕ Объект.ДополнительнаяСтрокаЭтикетки = ТекстЗаголовка Тогда
						Объект.ДополнительнаяСтрокаЭтикетки = ТекстЗаголовка;
					КонецЕсли;	
				КонецЕсли;
				
			Исключение 	
				ТекстОписаниеОшибки = ОписаниеОшибки();
				Сообщение = Новый СообщениеПользователю;
				Сообщение.Текст = ОбщийМодульПовтор.ПолучитьТекстНаЯзыке("Произошла ошибка") + ": " + ТекстОписаниеОшибки;
				Сообщение.Поле 	= "ФормулаДополнительнойСтроки";
				Сообщение.УстановитьДанные(Объект);
				Сообщение.Сообщить();
				
			КонецПопытки;	
		КонецЕсли;		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ДатаПриИзменении(Элемент)
	ОбновитьПримеры();
КонецПроцедуры

&НаКлиенте
Процедура ФормулаДополнительнойСтрокиПриИзменении(Элемент)
	ОбновитьПримеры();
КонецПроцедуры

&НаКлиенте
Процедура ДополнительнаяСтрокаЭтикеткиПриИзменении(Элемент)
	ОбновитьПримеры();
КонецПроцедуры

&НаКлиенте
Процедура ПропорцияЭтикеткиПриИзменении(Элемент)
	ПропорцияЭтикеткиПриИзмененииНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПропорцияЭтикеткиПриИзмененииНаСервере()
	
	Константы.ФорматЭтикетки.Установить(ПропорцияЭтикетки);
	ОбновитьПовторноИспользуемыеЗначения();
	
КонецПроцедуры

Процедура ОпределитьПроизвольнуюПечатнуюФорму(Знач НеЗаставлять = ЛОЖЬ)
	
	Если ИспользоватьПроизвольныеПечатныеФормы
		И ЗначениеЗаполнено(Объект.НоменклатурнаяГруппа) Тогда
		
		ПроизвольнаяПечатнаяФорма = ПолучитьРеквизитыНаСервере(Объект.НоменклатурнаяГруппа, "ПроизвольнаяПечатнаяФормаЭтикетки");
	КонецЕсли;
	
	Если ИспользоватьПроизвольныеПечатныеФормы
		И НЕ НеЗаставлять
		И НЕ ЗначениеЗаполнено(Объект.ПроизвольнаяПечатнаяФорма) Тогда
		
		ПроизвольнаяПечатнаяФорма = ОбщийМодульТекстСервер.ОпределитьПроизвольнуюПечатнуюФорму(ПредопределенноеЗначение("Перечисление.ВидыПечатныхФорм.Этикетка"), Объект.Дата);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ПроизвольнаяПечатнаяФорма) Тогда
		Объект.ПроизвольнаяПечатнаяФорма = ПроизвольнаяПечатнаяФорма;
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция   ПолучитьРеквизитыНаСервере(Знач Номенклатура, Знач Реквизит);
	Возврат Номенклатура[Реквизит];
КонецФункции

&НаКлиенте
Процедура Установить1(Команда)
	
	Для Каждого СтрокаТовара ИЗ объект.Товары Цикл
		СтрокаТовара.Количество = 1;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если Источник = "ПодключаемоеОборудование"
		И ВводДоступен() Тогда
		
		Если ИмяСобытия = "ScanData" Тогда
			
			Если Параметр[ 1 ] = Неопределено Тогда
				ТекКод = Параметр[ 0 ];
			Иначе
				ТекКод = Параметр[ 1 ][ 1 ];
			КонецЕсли;
			
			ОбработатьПолученныйШКНаКлиенте(ТекКод);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьПолученныйШКНаклиенте(Знач ТекКод)
	
	РезультатСтруктура = ОбработатьПолученныйШКНаСервере(ТекКод);		
	
	Если РезультатСтруктура.Результат = Неопределено Тогда // 0 - ничего		
		ОбщийМодульКлиент.ВыдатьСигнал(ТекКод);		
	КонецЕсли;	
	
КонецПроцедуры

&НаСервере
Функция   ОбработатьПолученныйШКНаСервере(Знач ТекКод, Знач Количество = 1)
	
	РезультатСтруктура = Новый Структура("Результат", Неопределено);
	
	РезультатОбработки = ОбщийМодульТоварСервер.ПолучитьНоменклатуруПоШтрихКоду(ТекКод, ИСТИНА, ИСТИНА);
	
	Если ЗначениеЗаполнено(РезультатОбработки.Номенклатура) Тогда
		ДобавитьПозициюНоменклатуры(РезультатОбработки);
		РезультатСтруктура.Результат = 1;
	КонецЕсли; 	 	
	
	Возврат РезультатСтруктура;
	
КонецФункции

&НаСервере
Процедура ДобавитьПозициюНоменклатуры(Знач НоменклатураВх, Знач НеСтановитсяНаЭтуСтроку = ЛОЖЬ, Знач множительКоличества = 1)
	
	СерияНоменклатуры = Неопределено;
	ЕдиницаИзмерения  = Неопределено;
	
	Номенклатура = НоменклатураВх.Номенклатура;
	Количество 	 = НоменклатураВх.Количество * множительКоличества * ОбщийМодульСервер.ПолучитьКоличествоПоУмолчанию(НоменклатураВх.Номенклатура);
	НоменклатураВх.Свойство("СерияНоменклатуры", СерияНоменклатуры);
	НоменклатураВх.Свойство("ЕдиницаИзмерения", ЕдиницаИзмерения);
	Цена 		 = 0;
	ЦенаЕсть 	 = НоменклатураВх.Свойство("Цена", Цена);
	
	ТоварВедетсяПоСериям = ВестиУчетСерийНоменклатуры И ОбщийМодульПовтор.ТоварВедетсяПоСериям(Номенклатура) и ЗначениеЗаполнено(СерияНоменклатуры);
	
	ПараметрыОтбора = Новый Структура;
	ПараметрыОтбора.Вставить("Номенклатура", Номенклатура);
	
	Если ТоварВедетсяПоСериям Тогда
		ПараметрыОтбора.Вставить("СерияНоменклатуры", СерияНоменклатуры);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ЕдиницаИзмерения) Тогда
		ПараметрыОтбора.Вставить("ЕдиницаИзмерения", ЕдиницаИзмерения);
	КонецЕсли;
	
	СтрокаТовара = Объект.Товары.НайтиСтроки(ПараметрыОтбора);
	
	Если СтрокаТовара.Количество() = 0 Тогда
		СтрокаТовара = Объект.Товары.Добавить();				
		СтрокаТовара.Номенклатура 	  = Номенклатура;
		СтрокаТовара.ЕдиницаИзмерения = ЕдиницаИзмерения;
		
		//Если ТоварВедетсяПоСериям 
		//	И НЕ СерииНоменклатурыВидны Тогда
		//	
		//	СерииНоменклатурыВидны = ИСТИНА;		
		//	Элементы.ТоварыСерияНоменклатуры.Видимость 	= ИСТИНА;
		//КонецЕсли;
		
	Иначе
		СтрокаТовара = СтрокаТовара[0];
	КонецЕсли;		
	
	СтрокаТовара.Количество = СтрокаТовара.Количество + Количество;
	Если ТоварВедетсяПоСериям Тогда			
		СтрокаТовара.Количество = 1;
		СтрокаТовара.серияНоменклатуры = серияНоменклатуры;				
	КонецЕсли;
	
	Если ЦенаЕсть Тогда
		СтрокаТовара.Цена = Цена;
	Иначе			
		СтрокаТовара.Цена = ПолучитьЦенуНаСервере(СтрокаТовара.Номенклатура, СтрокаТовара.Количество, СтрокаТовара.ЕдиницаИзмерения);
	КонецЕсли;		
	
	Если ОбщийМодульПовтор.ПолучитьЗначениеНастройкиИлиКонстанты("ИспользоватьСкидки") Тогда
		СтрокаТовара.ПроцентСкидки = ОбщийМодульСервер.ПолучитьПроцентСкидкиНаСервере(Номенклатура, СтрокаТовара.Количество, Объект.ВидЦен, , Объект.Склад);
	КонецЕсли;
	
	//		пересчитатьСтрокуНаСервере(СтрокаТовара);	
	
	Элементы.Товары.ТекущаяСтрока  = СтрокаТовара.ПолучитьИдентификатор();
	Элементы.Товары.ТекущийЭлемент = Элементы.ТоварыКоличество;			
	
КонецПроцедуры

&НаСервере
Функция   ПолучитьЦенуНаСервере(Знач Номенклатура, Знач Количество, Знач ЕдиницаИзмерения)
	
	Цена = 0 ;
	
	Если Цена = 0 Тогда
		Цена = ОбщийМодульСервер.ПолучитьЦенуНаСервере(Номенклатура, Объект.ВидЦен, , ЛОЖЬ, Количество, , , , , , ЕдиницаИзмерения);
	КонецЕсли;
	
	Возврат Цена;
	
КонецФункции

&НаКлиенте
Процедура ТоварыНоменклатураПриИзменении(Элемент)
	ПриИзмененииНоменклатуры();
КонецПроцедуры

&НаКлиенте
Процедура ПриИзмененииНоменклатуры()
	
	СтрокаТовара = Элементы.Товары.ТекущиеДанные;	
	
	Если НЕ СтрокаТовара = Неопределено Тогда
		
		Номенклатура = СтрокаТовара.Номенклатура;
		Если ЗначениеЗаполнено(Номенклатура) Тогда  		
			
			Если ЗначениеЗаполнено(СтрокаТовара.ЕдиницаИзмерения)
				И НЕ ОбщийМодульКлиент.ЕдиницаПринадлежитНоменклатуре(СтрокаТовара.Номенклатура, СтрокаТовара.ЕдиницаИзмерения) Тогда
				
				СтрокаТовара.ЕдиницаИзмерения = ПредопределенноеЗначение("Справочник.ЕдиницыИзмерения.ПустаяСсылка");
			КонецЕсли;
			
			Если СтрокаТовара.Количество = 0 тогда
				СтрокаТовара.Количество = ОбщийМодульСервер.ПолучитьКоличествоПоУмолчанию(Номенклатура);
				
				Если СтрокаТовара.Количество = 0 тогда
					СтрокаТовара.Количество = 1;
				КонецЕсли;
			КонецЕсли;
			
			СтрокаТовара.Цена = ОбщийМодульСервер.ПолучитьЦенуНаСервере(СтрокаТовара.Номенклатура, Объект.ВидЦен, Объект.Дата, ЛОЖЬ, СтрокаТовара.Количество, , , , , , СтрокаТовара.ЕдиницаИзмерения);
		КонецЕсли;	
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПодборНоменклатуры(Команда)
	
	ПараметрыФормы = Новый Структура("Дата", Объект.Дата);
	ПараметрыФормы.Вставить("Документ", Неопределено);
	ПараметрыФормы.Вставить("ВидЦен", Объект.ВидЦен);
	ПараметрыФормы.Вставить("Добавление", ИСТИНА);
	ПараметрыФормы.Вставить("Договор", Неопределено);
	ПараметрыФормы.Вставить("Склад", Объект.Склад);
	ПараметрыФормы.Вставить("Товары", Объект.Товары);
	ПараметрыФормы.Вставить("КлиентПоставщик", Неопределено);
	
	ИмяНеобходимойФормы = "Справочник.Номенклатура.Форма.ФормаПодбора";
	ОткрытьФорму(ИмяНеобходимойФормы, ПараметрыФормы, Элементы.Товары);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Если ЗначениеЗаполнено(ВыбранноеЗначение) Тогда
		Объект.Товары.Очистить();
		Для Каждого Подбор Из ВыбранноеЗначение Цикл
			
			Строка = Объект.Товары.Добавить();
			Строка.Номенклатура      = Подбор.Номенклатура;
			Строка.СерияНоменклатуры = Подбор.СерияНоменклатуры;
			Строка.Количество        = Подбор.Количество;
			Строка.Цена  			 = Подбор.Цена;
			
		КонецЦикла;
	КонецЕсли;	
	
КонецПроцедуры   

&НаКлиенте
Процедура ПечатьЕдиничнойЭтикетки(Команда)
	
	ОткрытьФорму("Обработка.ПечатьЭтикетки.Форма.Форма");
	Закрыть(ЛОЖЬ);
	
КонецПроцедуры
