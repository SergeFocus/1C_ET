//sza140117-0131 : 
//sza131003-1850 : 

Перем глЧислоОбъектов Экспорт;
Перем глПодключаемоеОборудование Экспорт;
Перем глКонфигурацияВРаботе Экспорт;

Процедура ПриНачалеРаботыСистемы()
	
	глКонфигурацияВРаботе = Истина;
	глЧислоОбъектов = ОбщийМодульПовтор.получитьЗначениеНастройкиИлиКонстанты("ЧислоОбъектов");
	ОбщийМодульКлиент.ПриНачалеРаботыСистемы();
	
	// ПодключаемоеОборудование
	МенеджерОборудованияКлиент.ПриНачалеРаботыСистемы();
	// Конец ПодключаемоеОборудование
	
	ПроверитьПодключениеОбработчикаОжидания();
	ДобавитьНапоминанияПриСтартеСистемы();
	
КонецПроцедуры

Процедура ПроверитьПодключениеОбработчикаОжидания() Экспорт
	
	Если Константы.ИспользоватьМеханизмЗаметокИНапоминаний.Получить() Тогда
		ПодключитьОбработчикОжидания("ВыполнениеРегламентныхЗаданий", 60);
	Иначе
		ОтключитьОбработчикОжидания("ВыполнениеРегламентныхЗаданий");
	КонецЕсли; 	
	
КонецПроцедуры

Процедура ВыполнениеРегламентныхЗаданий() Экспорт
	ОбщийМодульСерверПривилегия.ВыполнитьЗадачи();
КонецПроцедуры

Процедура ПередЗавершениемРаботыСистемы(Отказ)
	
	СледуетВыполнитьОперацииПередЗавершением = ОбщийМодульСервисСервер.СледуетВыполнитьОперацииПередЗавершением();
	Если Не СледуетВыполнитьОперацииПередЗавершением.количество() = 0 Тогда
		
		Количество = СледуетВыполнитьОперацииПередЗавершением.Количество();
		Для Каждого ОперацияПередЗавершением Из СледуетВыполнитьОперацииПередЗавершением Цикл
			
			Если ОперацияПередЗавершением = "Восстановление Валовой Прибыли" 
				и Вопрос(ОбщийМодульПовтор.ПолучитьТекстНаЯзыке("Необходимо восстановить показатели валовой прибыли. Восстановить сейчас?"), РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Да Тогда
				Состояние(ОбщийМодульПовтор.ПолучитьТекстНаЯзыке("Операция:") + " " + ОбщийМодульПовтор.ПолучитьТекстНаЯзыке(ОперацияПередЗавершением));
				ОбщийМодульСервисСервер.ПередЗавершениемРаботыСистемы(ОперацияПередЗавершением);		
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	// ПодключаемоеОборудование
	МенеджерОборудованияКлиент.ПередЗавершениемРаботыСистемы();
	// Конец ПодключаемоеОборудование
	
	ОбщийМодульСервисСервер.УстановитьЗначениеКонстанты("ЧислоОбъектов", глЧислоОбъектов) ;
	
КонецПроцедуры

Процедура ОбработкаВнешнегоСобытия(Источник, Событие, Данные)
	
	// Подготовить данные
	ОписаниеСобытия = Новый Структура();
	ОписаниеОшибки  = "";
	
	ОписаниеСобытия.Вставить("Источник", Источник);
	ОписаниеСобытия.Вставить("Событие",  Событие);
	ОписаниеСобытия.Вставить("Данные",   Данные);
	
	// Передать на обработку данные
	Результат = МенеджерОборудованияКлиент.ОбработатьСобытиеОтУстройства(ОписаниеСобытия, ОписаниеОшибки);
	Если Не Результат Тогда
		ОбщегоНазначения.СообщитьПользователю(ОбщийМодульПовтор.ПолучитьТекстНаЯзыке("При обработке внешнего события от устройства произошла ошибка.")
		+ Символы.ПС + ОписаниеОшибки);
	КонецЕсли;
	
КонецПроцедуры
