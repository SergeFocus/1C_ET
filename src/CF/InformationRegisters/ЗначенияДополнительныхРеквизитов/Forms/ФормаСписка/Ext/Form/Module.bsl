//sza140509-0126 SZA: 
//sza140106-2315 : 

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ОбщийМодульКлиент.СобытиеФормы(ЭтаФорма, 0);
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии()
	ОбщийМодульКлиент.СобытиеФормы(ЭтаФорма, 1);
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Не Отказ тогда
	Если ЗначениеЗаполнено(Параметры.ОбъектВладелец) Тогда
		ОбъектВладелец = Параметры.ОбъектВладелец;
		НаименованиеОбъектаВладельца = сокрлп(типзнч(ОбъектВладелец));
		
		ПроверитьНаличиеВсехРеквизитов();
		
	Иначе
		Элементы.ОбъектВладелец.Видимость = Истина;
		Элементы.ГруппаГоризонт.Видимость = Истина;
	КонецЕсли;
	
	Список.Параметры.УстановитьЗначениеПараметра("НетОтбораПоОбъектВладелец", НЕ ЗначениеЗаполнено(ОбъектВладелец));
	Список.Параметры.УстановитьЗначениеПараметра("ОбъектВладелец", ОбъектВладелец);
	
	Наименование = ОбщийМодульПовтор.ПолучитьКрасивоеНаименованиеОбъекта(НаименованиеОбъектаВладельца);
	
	элементы.ДобавитьДополнительныйРеквизит.Заголовок = ОбщийМодульПовтор.ПолучитьТекстНаЯзыке("Добавить дополнительный реквизит для") + " " + Наименование;
	элементы.ОбъектВладелец1.Заголовок = Наименование;
		ОбщийМодульСервер.ОбеспечитьСписокОтборов(Список);	
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПроверитьНаличиеВсехРеквизитов()
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ДополнительныеРеквизиты.Ссылка,
	|	ДополнительныеРеквизиты.ТипДополнительногоРеквизита,
	|	ДополнительныеРеквизиты.ЗначениеПоУмолчанию
	|ИЗ Справочник.ДополнительныеРеквизиты КАК ДополнительныеРеквизиты
	|ГДЕ ДополнительныеРеквизиты.НаименованиеОбъектаВладельца = &НаименованиеОбъектаВладельца
	|	И ДополнительныеРеквизиты.ПометкаУдаления = ЛОЖЬ";
	
	Запрос.УстановитьПараметр("НаименованиеОбъектаВладельца", НаименованиеОбъектаВладельца);
	
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();		
		
		ЗапросЗначения = Новый Запрос;
		ЗапросЗначения.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 ЗначенияДополнительныхРеквизитовСрезПоследних.ЗначениеРеквизита
		|ИЗ РегистрСведений.ЗначенияДополнительныхРеквизитов.СрезПоследних КАК ЗначенияДополнительныхРеквизитовСрезПоследних
		|ГДЕ ЗначенияДополнительныхРеквизитовСрезПоследних.ОбъектВладелец = &ОбъектВладелец
		|	И ЗначенияДополнительныхРеквизитовСрезПоследних.ДополнительныйРеквизит = &ДополнительныйРеквизит";
		ЗапросЗначения.УстановитьПараметр("ОбъектВладелец", ОбъектВладелец);
		
		ДатаПервогоДокумента = ОбщийМодульСервисСервер.ДатаПервогоДокумента();
		
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			ДополнительныйРеквизит  = ВыборкаДетальныеЗаписи.ссылка;
			ЗапросЗначения.УстановитьПараметр("ДополнительныйРеквизит", ДополнительныйРеквизит);
			
			РезультатЗапросЗначения = ЗапросЗначения.Выполнить();
			если РезультатЗапросЗначения.Пустой() тогда
				
				ДопРеквизит = РегистрыСведений.ЗначенияДополнительныхРеквизитов.СоздатьМенеджерЗаписи();
				ДопРеквизит.Активность = Истина;
				ДопРеквизит.ДополнительныйРеквизит = ДополнительныйРеквизит;
				ДопРеквизит.ЗначениеРеквизита = ВыборкаДетальныеЗаписи.ЗначениеПоУмолчанию;
				ДопРеквизит.ОбъектВладелец    = ОбъектВладелец;
				ДопРеквизит.Период			  = ДатаПервогоДокумента;
				
				Попытка //Записи в регистр сведений 
					ДопРеквизит.Записать(Истина);
					
				Исключение 
				КонецПопытки; 
				
			КонецЕсли;
			
		КонецЦикла;                        	
	КонецЕсли;
	
КонецПроцедуры //ПроверитьНаличиеВсехРеквизитов

&НаКлиенте
Процедура ДобавитьДополнительныйРеквизит(Команда)
	
	параметрыФормы = Новый Структура("ОбъектВладелец", ОбъектВладелец);
	ФормаНовогоДопРеквизита = ПолучитьФорму("Справочник.ДополнительныеРеквизиты.ФормаОбъекта", параметрыФормы);
	ФормаНовогоДопРеквизита.открытьмодально();
	ПроверитьНаличиеВсехРеквизитов();
	
КонецПроцедуры
